<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Pack (git.Git.Unpack.Pack)</title><link rel="stylesheet" href="../../../../_odoc-theme/odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc v1.1.1-1373-g2e7c1c75"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><nav><a href="../index.html">Up</a> â€“ <a href="../../../index.html">git</a> &#x00BB; <a href="../../index.html">Git</a> &#x00BB; <a href="../index.html">Unpack</a> &#x00BB; Pack</nav><header><h1>Module <code>Unpack.Pack</code></h1><h3 id="parameters"><a href="#parameters" class="anchor"></a>Parameters</h3><div class="spec parameter" id="argument-1-Hash" class="anchored"><a href="#argument-1-Hash" class="anchor"></a><code><span class="keyword">module</span> <a href="argument-1-Hash/index.html">Hash</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div class="spec parameter" id="argument-2-Inflate" class="anchored"><a href="#argument-2-Inflate" class="anchor"></a><code><span class="keyword">module</span> <a href="argument-2-Inflate/index.html">Inflate</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div class="spec parameter" id="argument-3-Hunk" class="anchored"><a href="#argument-3-Hunk" class="anchor"></a><code><span class="keyword">module</span> <a href="argument-3-Hunk/index.html">Hunk</a> : <a href="../module-type-H/index.html">H</a> <span class="keyword">with</span> <span class="keyword">module</span> <a href="../module-type-H/Hash/index.html">Hash</a> := <a href="argument-1-Hash/index.html">Hash</a></code></div><h3 id="signature"><a href="#signature" class="anchor"></a>Signature</h3></header><div class="content"><div><div class="spec type" id="type-error" class="anchored"><a href="#type-error" class="anchor"></a><code><span class="keyword">type</span> error = </code><table><tr id="type-error.Invalid_byte" class="anchored"><td class="def variant constructor"><a href="#type-error.Invalid_byte" class="anchor"></a><code>| <span class="constructor">Invalid_byte</span> <span class="keyword">of</span> int</code></td><td class="doc"><p>Appears when the header of the PACK file is wrong.</p></td></tr><tr id="type-error.Reserved_kind" class="anchored"><td class="def variant constructor"><a href="#type-error.Reserved_kind" class="anchor"></a><code>| <span class="constructor">Reserved_kind</span> <span class="keyword">of</span> int</code></td><td class="doc"><p>Appears when the kind of the current PACK object is <code>0</code>.</p></td></tr><tr id="type-error.Invalid_kind" class="anchored"><td class="def variant constructor"><a href="#type-error.Invalid_kind" class="anchor"></a><code>| <span class="constructor">Invalid_kind</span> <span class="keyword">of</span> int</code></td><td class="doc"><p>Appears when the kind of the current PACK object is undefined. TODO: this case does not appear, lol ...</p></td></tr><tr id="type-error.Inflate_error" class="anchored"><td class="def variant constructor"><a href="#type-error.Inflate_error" class="anchor"></a><code>| <span class="constructor">Inflate_error</span> <span class="keyword">of</span> <a href="argument-2-Inflate/index.html#type-error">Inflate.error</a></code></td><td class="doc"><p>Appears when the <a href="argument-2-Inflate/index.html"><code>Inflate</code></a> module returns an error when it tries to inflate a PACK object.</p></td></tr><tr id="type-error.Hunk_error" class="anchored"><td class="def variant constructor"><a href="#type-error.Hunk_error" class="anchor"></a><code>| <span class="constructor">Hunk_error</span> <span class="keyword">of</span> <a href="argument-3-Hunk/index.html#type-error">Hunk.error</a></code></td><td class="doc"><p>Appears when the <a href="../module-type-H/index.html"><code>H</code></a> module returns an error.</p></td></tr><tr id="type-error.Hunk_input" class="anchored"><td class="def variant constructor"><a href="#type-error.Hunk_input" class="anchor"></a><code>| <span class="constructor">Hunk_input</span> <span class="keyword">of</span> int * int</code></td><td class="doc"><p>The Hunk object is length-defined. So, when we try to decode this specific PACK object, if the decoder <a href="../module-type-H/index.html#type-t"><code>H.t</code></a> expects some new bytes and we already get all input, this error appears (with respectively how many byte(s) we expected and how many byte(s) the decoder <a href="../module-type-H/index.html#type-t"><code>H.t</code></a> computed).</p></td></tr><tr id="type-error.Invalid_length" class="anchored"><td class="def variant constructor"><a href="#type-error.Invalid_length" class="anchor"></a><code>| <span class="constructor">Invalid_length</span> <span class="keyword">of</span> int * int</code></td><td class="doc"><p>Appears when the length of the inflated object does not correspond by what was it noticed by the PACK file.</p></td></tr></table></div><div><p>The type error.</p></div></div><div><div class="spec value" id="val-pp_error" class="anchored"><a href="#val-pp_error" class="anchor"></a><code><span class="keyword">val</span> pp_error : <span><a href="index.html#type-error">error</a> <a href="../../../../fmt/Fmt/index.html#type-t">Fmt.t</a></span></code></div><div><p>Pretty-printer for an <a href="index.html#type-error"><code>error</code></a>.</p></div></div><div><div class="spec type" id="type-t" class="anchored"><a href="#type-t" class="anchor"></a><code><span class="keyword">type</span> t</code></div><div><p>The type of the decoder.</p></div></div><div><div class="spec value" id="val-pp" class="anchored"><a href="#val-pp" class="anchor"></a><code><span class="keyword">val</span> pp : <span><a href="index.html#type-t">t</a> <a href="../../../../fmt/Fmt/index.html#type-t">Fmt.t</a></span></code></div><div><p>Pretty-printer for <a href="index.html#type-t"><code>t</code></a>.</p></div></div><div class="spec type" id="type-kind" class="anchored"><a href="#type-kind" class="anchor"></a><code><span class="keyword">type</span> kind = </code><table><tr id="type-kind.Commit" class="anchored"><td class="def variant constructor"><a href="#type-kind.Commit" class="anchor"></a><code>| <span class="constructor">Commit</span></code></td></tr><tr id="type-kind.Tree" class="anchored"><td class="def variant constructor"><a href="#type-kind.Tree" class="anchor"></a><code>| <span class="constructor">Tree</span></code></td></tr><tr id="type-kind.Blob" class="anchored"><td class="def variant constructor"><a href="#type-kind.Blob" class="anchor"></a><code>| <span class="constructor">Blob</span></code></td></tr><tr id="type-kind.Tag" class="anchored"><td class="def variant constructor"><a href="#type-kind.Tag" class="anchor"></a><code>| <span class="constructor">Tag</span></code></td></tr><tr id="type-kind.Hunk" class="anchored"><td class="def variant constructor"><a href="#type-kind.Hunk" class="anchor"></a><code>| <span class="constructor">Hunk</span> <span class="keyword">of</span> <a href="argument-3-Hunk/index.html#type-hunks">Hunk.hunks</a></code></td><td class="doc"><p>The kind of the PACK object. It can be:</p><ul><li>A <code>Commit</code></li><li>A <code>Tree</code></li><li>A <code>Blob</code></li><li>A <code>Tag</code></li><li>A <code>Hunk</code>: this is not a git object but a specific PCK object. The <a href="../module-type-H/index.html#type-hunks"><code>H.hunks</code></a> refers to another PACK object by <a href="../module-type-H/index.html#type-reference"><code>H.reference</code></a> and it's just a result of a diff between the reference and the current object.</li></ul></td></tr></table></div><div><div class="spec value" id="val-default" class="anchored"><a href="#val-default" class="anchor"></a><code><span class="keyword">val</span> default : <a href="../../../../cstruct/Cstruct/index.html#type-t">Cstruct.t</a> <span>&#45;&gt;</span> <a href="argument-2-Inflate/index.html#type-window">Inflate.window</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a></code></div><div><p><code>default tmp window</code> makes a new decoder of a PACK file.</p><p><code>tmp</code> is a <code>Cstruct.t</code> used as an internal output of the inflated stream. We let the user to allocate the optimized length for this temporary buffer and we take the ownership (so, you don't use it to another compute).</p><p><code>window</code> is the <code>Inflate.window</code> needed to inflate. We keep this window as long as we use have objects in the PACK stream and reset it for each object (and avoid any needed allocation). Then, we take the ownership so you are not able to use it for another process.</p><p>This state does not allocate any large caml value.</p></div></div><div><div class="spec value" id="val-many" class="anchored"><a href="#val-many" class="anchor"></a><code><span class="keyword">val</span> many : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> int32</code></div><div><p><code>many t</code> returns how many objects will/did compute for the current stream.</p></div></div><div><div class="spec value" id="val-from_window" class="anchored"><a href="#val-from_window" class="anchor"></a><code><span class="keyword">val</span> from_window : <a href="../Window/index.html#type-t">Window.t</a> <span>&#45;&gt;</span> int <span>&#45;&gt;</span> <a href="../../../../cstruct/Cstruct/index.html#type-t">Cstruct.t</a> <span>&#45;&gt;</span> <a href="argument-2-Inflate/index.html#type-window">Inflate.window</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a></code></div><div><p><code>from_window pack_window off_in_window tmp window</code> makes a new decoder of a PACK file specialized from a <a href="../Window/index.html#type-t"><code>Window.t</code></a>. This decoder compute only one object in a precise offset (noticed by <code>pack_window</code> and the relative offset <code>off_in_window</code>). Then <code>tmp</code> and <code>window</code> have the same purpose than <a href="index.html#val-default"><code>default</code></a>. For this state, <a href="index.html#val-eval"><code>eval</code></a> has a different behaviour. Indeed, after the specified object de-serialized, <a href="index.html#val-eval"><code>eval</code></a> returns directly <code>`End</code> even if it's not the last object in the PACK stream. Then, the hash produced is empty.</p></div></div><div><div class="spec value" id="val-process_length" class="anchored"><a href="#val-process_length" class="anchor"></a><code><span class="keyword">val</span> process_length : <a href="../Window/index.html#type-t">Window.t</a> <span>&#45;&gt;</span> int <span>&#45;&gt;</span> <a href="../../../../cstruct/Cstruct/index.html#type-t">Cstruct.t</a> <span>&#45;&gt;</span> <a href="argument-2-Inflate/index.html#type-window">Inflate.window</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a></code></div><div><p><code>process_length pack_window off_in_window tmp window</code> makes a new specific decoder only to get the real length of the PACK object specified by <code>pack_window</code> and the relative offset <code>off_in_window</code>. This decoder is only able to be used with <a href="index.html#val-eval_length"><code>eval_length</code></a> (and not <a href="index.html#val-eval"><code>eval</code></a>). For all git object, we can catch the real inflated length of the expected object. For the <code>Hunk _</code> object, we can get the real inflated length of the PACK object and call <a href="../module-type-H/index.html#val-partial_hunks"><code>H.partial_hunks</code></a> with the internal Hunk decoder state. This compute appear only when <a href="index.html#val-eval_length"><code>eval_length</code></a> returns <code>`Length</code>.</p><p>This decoder is focused to only get the length of the PACK object. So we inflate for example only what it needed to get this information. So, obviously, it is more faster than <a href="index.html#val-eval"><code>eval</code></a> and compute all of the object to get the information then.</p></div></div><div><div class="spec value" id="val-process_metadata" class="anchored"><a href="#val-process_metadata" class="anchor"></a><code><span class="keyword">val</span> process_metadata : <a href="../Window/index.html#type-t">Window.t</a> <span>&#45;&gt;</span> int <span>&#45;&gt;</span> <a href="../../../../cstruct/Cstruct/index.html#type-t">Cstruct.t</a> <span>&#45;&gt;</span> <a href="argument-2-Inflate/index.html#type-window">Inflate.window</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a></code></div><div><p><code>process_metadata</code> same purpose than <a href="index.html#val-process_length"><code>process_length</code></a> but stop the decoder to a step to get some meta-data about the expected PACK object.</p></div></div><div><div class="spec value" id="val-refill" class="anchored"><a href="#val-refill" class="anchor"></a><code><span class="keyword">val</span> refill : int <span>&#45;&gt;</span> int <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a></code></div><div><p><code>refill off len t</code> provides a new <code>t</code> with <code>len</code> bytes to read, starting at <code>off</code>. This byte range is read by calls to <a href="index.html#val-eval"><code>eval</code></a> with <code>t</code> until <code>`Await</code> is returned.</p></div></div><div><div class="spec value" id="val-flush" class="anchored"><a href="#val-flush" class="anchor"></a><code><span class="keyword">val</span> flush : int <span>&#45;&gt;</span> int <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a></code></div><div><p><code>flush off len t</code> provides <code>t</code> with <code>len</code> bytes to write, starting at <code>off</code>. This byte range is written by calls to <a href="index.html#val-eval"><code>eval</code></a> with <code>t</code> until <code>`Flush</code> is returned. Use <a href="index.html#val-output"><code>output</code></a> to know how many byte <code>t</code> wrote.</p></div></div><div><div class="spec value" id="val-next_object" class="anchored"><a href="#val-next_object" class="anchor"></a><code><span class="keyword">val</span> next_object : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a></code></div><div><p><code>next_object t</code> provides a new <code>t</code> which continue the de-serialization of the PACK stream. Indeed, when the client catches a new <code>`Object</code>, the decoder sticks on the this situation. So to move to the next step, the client have to call <a href="index.html#val-next_object"><code>next_object</code></a> to continue the process.</p></div></div><div><div class="spec value" id="val-continue" class="anchored"><a href="#val-continue" class="anchor"></a><code><span class="keyword">val</span> continue : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a></code></div><div><p><code>continue t</code> defers <a href="../module-type-H/index.html#val-continue"><code>H.continue</code></a> to the internal state <a href="../module-type-H/index.html#type-t"><code>H.t</code></a>. The client is able to use it only when <a href="index.html#val-eval"><code>eval</code></a>/<a href="index.html#val-eval_length"><code>eval_length</code></a>/<a href="index.html#val-eval_metadata"><code>eval_metadata</code></a> returns <code>`Hunk</code>.</p></div></div><aside><p>Meta-data information.</p></aside><div><div class="spec value" id="val-kind" class="anchored"><a href="#val-kind" class="anchor"></a><code><span class="keyword">val</span> kind : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#type-kind">kind</a></code></div><div><p><code>kind t</code> returns the <a href="index.html#val-kind"><code>kind</code></a> of the current object. The client is able to use this function only when <a href="index.html#val-eval"><code>eval</code></a> returns <code>`Object</code> or <code>`Hunk</code>. Otherwise, we raise an <code>Invalid_argument</code>. This function is available when the client process the meta-data of the expected object and can call it when <a href="index.html#val-eval_metadata"><code>eval_metadata</code></a> returns <code>`Metadata</code>.</p></div></div><div><div class="spec value" id="val-length" class="anchored"><a href="#val-length" class="anchor"></a><code><span class="keyword">val</span> length : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> int</code></div><div><p><code>length t</code> returns the real inflated length of the current object in the PACK stream. The client is able to use this function only when <a href="index.html#val-eval"><code>eval</code></a> returns <code>`Object</code> or <code>`Hunk</code>. Otherwise, we raise an <code>Invalid_argument</code>. This function is available when the client process the length of the expected object and can call it when <a href="index.html#val-eval_length"><code>eval_length</code></a> returns <code>`Length</code>.</p></div></div><div><div class="spec value" id="val-offset" class="anchored"><a href="#val-offset" class="anchor"></a><code><span class="keyword">val</span> offset : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> int64</code></div><div><p><code>offset t</code> returns the absolute offset of the current object in the PACK file. The client is able to use this function only when <a href="index.html#val-eval"><code>eval</code></a> returns <code>`Object</code> or <code>`Hunk</code>. Otherwise, we raise an <code>Invalid_argument</code>. This function is available when the client process the meta-data of the expected object and can call it when <a href="index.html#val-eval_metadata"><code>eval_metadata</code></a> returns <code>`Metadata</code>.</p></div></div><div><div class="spec value" id="val-consumed" class="anchored"><a href="#val-consumed" class="anchor"></a><code><span class="keyword">val</span> consumed : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> int</code></div><div><p><code>consumed t</code> returns how many byte(s) the decoder consumed to de-serialize the current/expected object in the PACK stream. The client is able to use it only when <a href="index.html#val-eval"><code>eval</code></a> returns <code>`Object</code>. Otherwise, we raise an <code>Invalid_argument</code>.</p></div></div><div><div class="spec value" id="val-crc" class="anchored"><a href="#val-crc" class="anchor"></a><code><span class="keyword">val</span> crc : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../../../checkseum/Checkseum/Crc32/index.html#type-t">Checkseum.Crc32.t</a></code></div><div><p><code>crc t</code> returns the CRC-32 checksum computed when the decoder consumed all byte(s) needed to de-serialize the current/expected object. The client is able to use this function only when <a href="index.html#val-eval"><code>eval</code></a> returns <code>`Object</code>. Otherwise, we raise an <code>Invalid_argument</code>.</p></div></div><div><div class="spec value" id="val-output" class="anchored"><a href="#val-output" class="anchor"></a><code><span class="keyword">val</span> output : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../../../cstruct/Cstruct/index.html#type-t">Cstruct.t</a> * int</code></div><div><p><code>output t</code> returns the output produced by the decoder <code>t</code> when it inflates a git object. The <code>Cstruct.t</code> is physically the same than <code>tmp</code> noticed when the client makes the decoder <code>t</code>. Then, <code>output</code> returns how many byte(s) the decoder wrote inside <code>tmp</code>. The client is able to use this function only when the kind of the current pack object processed is different to <code>Hunk</code>. Otherwise, we raise an error.</p></div></div><div><div class="spec value" id="val-eval" class="anchored"><a href="#val-eval" class="anchor"></a><code><span class="keyword">val</span> eval : <a href="../../../../cstruct/Cstruct/index.html#type-t">Cstruct.t</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span>[ <span>`Object of <a href="index.html#type-t">t</a></span> <span><span>| `Hunk</span> of <a href="index.html#type-t">t</a> * <a href="argument-3-Hunk/index.html#type-hunk">Hunk.hunk</a></span> <span><span>| `Await</span> of <a href="index.html#type-t">t</a></span> <span><span>| `Flush</span> of <a href="index.html#type-t">t</a></span> <span><span>| `End</span> of <a href="index.html#type-t">t</a> * <a href="argument-1-Hash/index.html#type-t">Hash.t</a></span> <span><span>| `Error</span> of <a href="index.html#type-t">t</a> * <a href="index.html#type-error">error</a></span> ]</span></code></div><div><p><code>eval src t</code> is:</p><ul><li><code>`Await t</code> iff <code>t</code> more input storage. The client muse use <a href="index.html#val-refill"><code>refill</code></a> to provide a new buffer and then call <a href="index.html#val-eval"><code>eval</code></a> with <code>`Await</code> until other value returned.</li><li><code>`Object t</code> iff <code>t</code> finishes to compute one object. The client is able to use the meta-data functions (like <a href="index.html#val-kind"><code>kind</code></a> or <a href="index.html#val-crc"><code>crc</code></a>) and should use <a href="index.html#val-next_object"><code>next_object</code></a> to move the decoder to the next step. Otherwise, the decoder <code>t</code> sticks in this situation.</li><li><code>Hunk (t, hunk)</code> defers the value returned by the internal <a href="../module-type-H/index.html#type-t"><code>H.t</code></a> decoder. The client should use <a href="index.html#val-continue"><code>continue</code></a> to move the decoder to the next step. In this situation, we ensure than the future <a href="index.html#val-kind"><code>kind</code></a> of the current/expected object is <code>Hunk _</code>.</li><li><code>`Flush t</code> iff <code>t</code> needs more output storage. The client must use <a href="index.html#val-flush"><code>flush</code></a> to provide a new buffer and then call <a href="index.html#val-eval"><code>eval</code></a> with <code>`Flush</code> until <code>`Object</code> is returned. In this situation, we ensure than the future <a href="index.html#val-kind"><code>kind</code></a> of the current/expected object is different than the <code>Hunk _</code>.</li><li><code>`End (t, hash)</code> when the decoder is done. <code>t</code> sticks to this situation. The client can remove it. We return the hash produced by the PACK stream.</li><li><code>`Error (t, exn)</code> iff the decoder meet an <a href="index.html#type-error"><code>error</code></a> <code>exn</code>. The decoder can't continue and sticks in this situation.</li></ul></div></div><div><div class="spec value" id="val-eval_length" class="anchored"><a href="#val-eval_length" class="anchor"></a><code><span class="keyword">val</span> eval_length : <a href="../../../../cstruct/Cstruct/index.html#type-t">Cstruct.t</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span>[ <span>`Length of <a href="index.html#type-t">t</a></span> <span><span>| `Await</span> of <a href="index.html#type-t">t</a></span> <span><span>| `Flush</span> of <a href="index.html#type-t">t</a></span> <span><span>| `End</span> of <a href="index.html#type-t">t</a> * <a href="argument-1-Hash/index.html#type-t">Hash.t</a></span> <span><span>| `Error</span> of <a href="index.html#type-t">t</a> * <a href="index.html#type-error">error</a></span> ]</span></code></div><div><p><code>eval_length src t</code> has the same purpose than <a href="index.html#val-eval"><code>eval</code></a> plus:</p><ul><li><code>`Length t</code> iff <code>t</code> can return the real inflated length of the current/expected object. The client should use <a href="index.html#val-length"><code>length</code></a> to get this information.</li></ul></div></div><div><div class="spec value" id="val-eval_metadata" class="anchored"><a href="#val-eval_metadata" class="anchor"></a><code><span class="keyword">val</span> eval_metadata : <a href="../../../../cstruct/Cstruct/index.html#type-t">Cstruct.t</a> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span>[ <span>`Metadata of <a href="index.html#type-t">t</a></span> <span><span>| `Await</span> of <a href="index.html#type-t">t</a></span> <span><span>| `Flush</span> of <a href="index.html#type-t">t</a></span> <span><span>| `End</span> of <a href="index.html#type-t">t</a> * <a href="argument-1-Hash/index.html#type-t">Hash.t</a></span> <span><span>| `Error</span> of <a href="index.html#type-t">t</a> * <a href="index.html#type-error">error</a></span> ]</span></code></div><div><p><code>eval_length src t</code> has the same purpose than <a href="index.html#val-eval"><code>eval</code></a> plus:</p><ul><li><code>`Metadata t</code> iff <code>t</code> can be used with meta-data functions (like <a href="index.html#val-kind"><code>kind</code></a> or <a href="index.html#val-length"><code>length</code></a>).</li></ul></div></div></div></body></html>