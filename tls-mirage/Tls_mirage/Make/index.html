<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Make (tls-mirage.Tls_mirage.Make)</title><link rel="stylesheet" href="../../../_odoc-theme/odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc v1.1.1-1373-g2e7c1c75"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><nav><a href="../index.html">Up</a> – <a href="../../index.html">tls-mirage</a> &#x00BB; <a href="../index.html">Tls_mirage</a> &#x00BB; Make</nav><header><h1>Module <code>Tls_mirage.Make</code></h1><aside><p>TLS module given a flow</p></aside><h3 id="parameters"><a href="#parameters" class="anchor"></a>Parameters</h3><div class="spec parameter" id="argument-1-F" class="anchored"><a href="#argument-1-F" class="anchor"></a><code><span class="keyword">module</span> <a href="argument-1-F/index.html">F</a> : <a href="../../../mirage-flow/Mirage_flow/module-type-S/index.html">Mirage_flow.S</a></code></div><h3 id="signature"><a href="#signature" class="anchor"></a>Signature</h3></header><div class="content"><div class="spec module" id="module-FLOW" class="anchored"><a href="#module-FLOW" class="anchor"></a><code><span class="keyword">module</span> FLOW = <a href="argument-1-F/index.html">F</a></code></div><div><div class="spec type" id="type-error" class="anchored"><a href="#type-error" class="anchor"></a><code><span class="keyword">type</span> error = [ </code><table><tr id="type-error.Tls_alert" class="anchored"><td class="def constructor"><a href="#type-error.Tls_alert" class="anchor"></a><code>| </code><code>`Tls_alert <span class="keyword">of</span> <a href="../../../tls/Tls/Packet/index.html#type-alert_type">Tls.Packet.alert_type</a></code></td></tr><tr id="type-error.Tls_failure" class="anchored"><td class="def constructor"><a href="#type-error.Tls_failure" class="anchor"></a><code>| </code><code>`Tls_failure <span class="keyword">of</span> <a href="../../../tls/Tls/Engine/index.html#type-failure">Tls.Engine.failure</a></code></td></tr><tr id="type-error.Read" class="anchored"><td class="def constructor"><a href="#type-error.Read" class="anchor"></a><code>| </code><code>`Read <span class="keyword">of</span> <a href="argument-1-F/index.html#type-error">F.error</a></code></td></tr><tr id="type-error.Write" class="anchored"><td class="def constructor"><a href="#type-error.Write" class="anchor"></a><code>| </code><code>`Write <span class="keyword">of</span> <a href="argument-1-F/index.html#type-write_error">F.write_error</a></code></td></tr></table><code> ]</code></div><div><p>possible errors: incoming alert, processing failure, or a problem in the underlying flow.</p></div></div><div><div class="spec type" id="type-write_error" class="anchored"><a href="#type-write_error" class="anchor"></a><code><span class="keyword">type</span> write_error = [ </code><table><tr id="type-write_error.Closed" class="anchored"><td class="def constructor"><a href="#type-write_error.Closed" class="anchor"></a><code>| </code><code>`Closed</code></td></tr><tr id="type-write_error.error" class="anchored"><td class="def type"><a href="#type-write_error.error" class="anchor"></a><code>| </code><code><a href="index.html#type-error">error</a></code></td></tr></table><code> ]</code></div><div><p>The type for write errors.</p></div></div><div class="spec type" id="type-buffer" class="anchored"><a href="#type-buffer" class="anchor"></a><code><span class="keyword">type</span> buffer = <a href="../../../cstruct/Cstruct/index.html#type-t">Cstruct.t</a></code></div><div class="spec type" id="type-io" class="anchored"><a href="#type-io" class="anchor"></a><code><span class="keyword">type</span> <span>+'a io</span> = <span><span class="type-var">'a</span> <a href="../../../lwt/Lwt/index.html#type-t">Lwt.t</a></span></code></div><div><div class="spec include"><div class="doc"><p>we provide the FLOW interface</p><details open="open"><summary><span class="def"><code><span class="keyword">include</span> <a href="../../../mirage-flow/Mirage_flow/module-type-S/index.html">Mirage_flow.S</a> <span class="keyword">with</span> <span class="keyword">type</span> <a href="../../../mirage-flow/Mirage_flow/module-type-S/index.html#type-error">error</a> := <a href="index.html#type-error">error</a> <span class="keyword">and</span> <span class="keyword">type</span> <a href="../../../mirage-flow/Mirage_flow/module-type-S/index.html#type-write_error">write_error</a> := <a href="index.html#type-write_error">write_error</a></code></span></summary><div><div class="spec value" id="val-pp_error" class="anchored"><a href="#val-pp_error" class="anchor"></a><code><span class="keyword">val</span> pp_error : <span><a href="index.html#type-error">error</a> <a href="../../../fmt/Fmt/index.html#type-t">Fmt.t</a></span></code></div><div><p><code>pp_error</code> is the pretty-printer for errors.</p></div></div><div><div class="spec type" id="type-write_error#row" class="anchored"><a href="#type-write_error#row" class="anchor"></a><code><span class="keyword">type</span> <span class="keyword">nonrec</span> write_error#row</code></div><div><p>The type for write errors.</p></div></div><div><div class="spec value" id="val-pp_write_error" class="anchored"><a href="#val-pp_write_error" class="anchor"></a><code><span class="keyword">val</span> pp_write_error : <span><a href="index.html#type-write_error">write_error</a> <a href="../../../fmt/Fmt/index.html#type-t">Fmt.t</a></span></code></div><div><p><code>pp_write_error</code> is the pretty-printer for write errors.</p></div></div><div><div class="spec type" id="type-flow" class="anchored"><a href="#type-flow" class="anchor"></a><code><span class="keyword">type</span> flow</code></div><div><p>The type for flows. A flow represents the state of a single reliable stream that is connected to an endpoint.</p></div></div><div><div class="spec value" id="val-read" class="anchored"><a href="#val-read" class="anchor"></a><code><span class="keyword">val</span> read : <a href="index.html#type-flow">flow</a> <span>&#45;&gt;</span> <span><span><span>(<span><a href="../../../cstruct/Cstruct/index.html#type-t">Cstruct.t</a> <a href="../../../mirage-flow/Mirage_flow/index.html#type-or_eof">Mirage_flow.or_eof</a></span>, <a href="index.html#type-error">error</a>)</span> <a href="../../../ocaml/Stdlib/index.html#type-result">Stdlib.result</a></span> <a href="../../../lwt/Lwt/index.html#type-t">Lwt.t</a></span></code></div><div><p><code>read flow</code> blocks until some data is available and returns a fresh buffer containing it.</p><p>The returned buffer will be of a size convenient to the flow implementation, but will always have at least 1 byte.</p><p>If the remote endpoint calls <code>close</code> then calls to <code>read</code> will keep returning data until all the in-flight data has been read. <code>read flow</code> will return <code>`Eof</code> when the remote endpoint has called <code>close</code> and when there is no more in-flight data.</p></div></div><div><div class="spec value" id="val-write" class="anchored"><a href="#val-write" class="anchor"></a><code><span class="keyword">val</span> write : <a href="index.html#type-flow">flow</a> <span>&#45;&gt;</span> <a href="../../../cstruct/Cstruct/index.html#type-t">Cstruct.t</a> <span>&#45;&gt;</span> <span><span><span>(unit, <a href="index.html#type-write_error">write_error</a>)</span> <a href="../../../ocaml/Stdlib/index.html#type-result">Stdlib.result</a></span> <a href="../../../lwt/Lwt/index.html#type-t">Lwt.t</a></span></code></div><div><p><code>write flow buffer</code> writes a buffer to the flow. There is no indication when the buffer has actually been read and, therefore, it must not be reused. The contents may be transmitted in separate packets, depending on the underlying transport. The result <code>Ok ()</code> indicates success, <code>Error `Closed</code> indicates that the connection is now closed and therefore the data could not be written. Other errors are possible.</p></div></div><div><div class="spec value" id="val-writev" class="anchored"><a href="#val-writev" class="anchor"></a><code><span class="keyword">val</span> writev : <a href="index.html#type-flow">flow</a> <span>&#45;&gt;</span> <span><a href="../../../cstruct/Cstruct/index.html#type-t">Cstruct.t</a> list</span> <span>&#45;&gt;</span> <span><span><span>(unit, <a href="index.html#type-write_error">write_error</a>)</span> <a href="../../../ocaml/Stdlib/index.html#type-result">Stdlib.result</a></span> <a href="../../../lwt/Lwt/index.html#type-t">Lwt.t</a></span></code></div><div><p><code>writev flow buffers</code> writes a sequence of buffers to the flow. There is no indication when the buffers have actually been read and, therefore, they must not be reused. The result <code>Ok ()</code> indicates success, <code>Error `Closed</code> indicates that the connection is now closed and therefore the data could not be written. Other errors are possible.</p></div></div><div><div class="spec value" id="val-close" class="anchored"><a href="#val-close" class="anchor"></a><code><span class="keyword">val</span> close : <a href="index.html#type-flow">flow</a> <span>&#45;&gt;</span> <span>unit <a href="../../../lwt/Lwt/index.html#type-t">Lwt.t</a></span></code></div><div><p><code>close flow</code> flushes all pending writes and signals the remote endpoint that there will be no future writes. Once the remote endpoint has read all pending data, it is expected that calls to <code>read</code> on the remote return <code>`Eof</code>.</p><p>Note it is still possible for the remote endpoint to <code>write</code> to the flow and for the local endpoint to call <code>read</code>. This state where the local endpoint has called <code>close</code> but the remote endpoint has not called <code>close</code> is similar to that of a half-closed TCP connection or a Unix socket after <code>shutdown(SHUTDOWN_WRITE)</code>.</p><p><code>close flow</code> waits until the remote endpoint has also called <code>close</code> before returning. At this point no data can flow in either direction and resources associated with the flow can be freed.</p></div></div></details></div></div></div><div><div class="spec value" id="val-reneg" class="anchored"><a href="#val-reneg" class="anchor"></a><code><span class="keyword">val</span> reneg : <span>?&#8288;authenticator:<a href="../../../x509/X509/Authenticator/index.html#type-t">X509.Authenticator.t</a></span> <span>&#45;&gt;</span> <span>?&#8288;acceptable_cas:<span><a href="../../../x509/X509/Distinguished_name/index.html#type-t">X509.Distinguished_name.t</a> list</span></span> <span>&#45;&gt;</span> <span>?&#8288;cert:<a href="../../../tls/Tls/Config/index.html#type-own_cert">Tls.Config.own_cert</a></span> <span>&#45;&gt;</span> <span>?&#8288;drop:bool</span> <span>&#45;&gt;</span> <a href="index.html#type-flow">flow</a> <span>&#45;&gt;</span> <span><span><span>(unit, <a href="index.html#type-write_error">write_error</a>)</span> <a href="../../../ocaml/Stdlib/index.html#type-result">Stdlib.result</a></span> <a href="../../../lwt/Lwt/index.html#type-t">Lwt.t</a></span></code></div><div><p><code>reneg ~authenticator ~acceptable_cas ~cert ~drop t</code> renegotiates the session, and blocks until the renegotiation finished. Optionally, a new <code>authenticator</code> and <code>acceptable_cas</code> can be used. The own certificate can be adjusted by <code>cert</code>. If <code>drop</code> is <code>true</code> (the default), application data received before the renegotiation finished is dropped.</p></div></div><div><div class="spec value" id="val-key_update" class="anchored"><a href="#val-key_update" class="anchor"></a><code><span class="keyword">val</span> key_update : <span>?&#8288;request:bool</span> <span>&#45;&gt;</span> <a href="index.html#type-flow">flow</a> <span>&#45;&gt;</span> <span><span><span>(unit, <a href="index.html#type-write_error">write_error</a>)</span> <a href="../../../ocaml/Stdlib/index.html#type-result">Stdlib.result</a></span> <a href="../../../lwt/Lwt/index.html#type-t">Lwt.t</a></span></code></div><div><p><code>key_update ~request t</code> updates the traffic key and requests a traffic key update from the peer if <code>request</code> is provided and <code>true</code> (the default). This is only supported in TLS 1.3.</p></div></div><div><div class="spec value" id="val-client_of_flow" class="anchored"><a href="#val-client_of_flow" class="anchor"></a><code><span class="keyword">val</span> client_of_flow : <a href="../../../tls/Tls/Config/index.html#type-client">Tls.Config.client</a> <span>&#45;&gt;</span> <span>?&#8288;host:string</span> <span>&#45;&gt;</span> <a href="argument-1-F/index.html#type-flow">FLOW.flow</a> <span>&#45;&gt;</span> <span><span><span>(<a href="index.html#type-flow">flow</a>, <a href="index.html#type-write_error">write_error</a>)</span> <a href="../../../ocaml/Stdlib/index.html#type-result">Stdlib.result</a></span> <a href="../../../lwt/Lwt/index.html#type-t">Lwt.t</a></span></code></div><div><p><code>client_of_flow client ~host flow</code> upgrades the existing connection to TLS using the <code>client</code> configuration, using <code>host</code> as peer name.</p></div></div><div><div class="spec value" id="val-server_of_flow" class="anchored"><a href="#val-server_of_flow" class="anchor"></a><code><span class="keyword">val</span> server_of_flow : <a href="../../../tls/Tls/Config/index.html#type-server">Tls.Config.server</a> <span>&#45;&gt;</span> <a href="argument-1-F/index.html#type-flow">FLOW.flow</a> <span>&#45;&gt;</span> <span><span><span>(<a href="index.html#type-flow">flow</a>, <a href="index.html#type-write_error">write_error</a>)</span> <a href="../../../ocaml/Stdlib/index.html#type-result">Stdlib.result</a></span> <a href="../../../lwt/Lwt/index.html#type-t">Lwt.t</a></span></code></div><div><p><code>server_of_flow server flow</code> upgrades the flow to a TLS connection using the <code>server</code> configuration.</p></div></div><div><div class="spec value" id="val-epoch" class="anchored"><a href="#val-epoch" class="anchor"></a><code><span class="keyword">val</span> epoch : <a href="index.html#type-flow">flow</a> <span>&#45;&gt;</span> <span><span>(<a href="../../../tls/Tls/Core/index.html#type-epoch_data">Tls.Core.epoch_data</a>, unit)</span> <a href="../../../ocaml/Stdlib/index.html#type-result">Stdlib.result</a></span></code></div><div><p><code>epoch flow</code> extracts information of the established session.</p></div></div></div></body></html>