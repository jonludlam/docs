<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Arp_handler (arp.Arp_handler)</title><link rel="stylesheet" href="../../_odoc-theme/odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc v1.1.1-1373-g2e7c1c75"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><nav><a href="../index.html">Up</a> â€“ <a href="../index.html">arp</a> &#x00BB; Arp_handler</nav><header><h1>Module <code>Arp_handler</code></h1><p>Protocol handler for the Address Resolution Protocol</p><p>This library provides a pure implementation of ARP, which handles only IPv4 addresses as protocol and Ethernet (MAC) addresses as hardware. This is the most common usage of ARP currently. There is no support for other types of addresses. ARP is initially specified in <a href="https://tools.ietf.org/html/rfc826">, RFC826</a>, and further refined in <a href="https://tools.ietf.org/html/rfc1122">, RFC1122</a> and partially <a href="https://tools.ietf.org/html/rfc5227">, RFC5227</a>.</p><p>The ARP handler consists of a cache, which maps IPv4 addresses to Ethernet addresses, and access to it. Its configuration is set during <span class="xref-unresolved">construction</span>, together with the own IPv4 address and Ethernet address. The cache can be modified with <span class="xref-unresolved">static</span> entries of other hosts, <span class="xref-unresolved">IPv4 aliases</span>, <span class="xref-unresolved">removal</span> of entries. Outgoing frames always use its <span class="xref-unresolved">main IPv4 address</span>. Whether an entry <span class="xref-unresolved">is available</span> or not can be inspected.</p><p>The ARP handler can process <span class="xref-unresolved">network input</span>, which may extend the cache with dynamic ARP entries which time out after the configured period. Periodic calls to <code>tick</code> are required for the timeout and retry mechanisms. Since ARP usually uses network communication, callers may <code>query</code> the cache and wait until either a response was received or a timeout occured after several retries.</p><p>The embedded merge strategy is simple: static entries always win (and thus, both <code>alias</code> and <code>static</code> overwrite existing entries). Log messages at the are generated if an ARP reply wants to overwrite a static entry, or the Ethernet address of a dynamic entry changed.</p><p>ARP frames which should be send on the wire are given as a pair of buffer and destination address, to be passed to the underlying layer (usually Ethernet). When adding entries, gratuitous ARP frames are to be sent.</p><p>While the <a href="../Arp_packet/index.html"><code>Arp_packet</code></a> module is exposed, for normal operation it is not needed, but this module should be sufficient.</p><p><em>v2.2.1 - <a href="https://github.com/mirage/arp">homepage</a></em></p></header><nav class="toc"><ul><li><a href="#constructor">Constructor</a></li><li><a href="#predicates">Predicates</a></li><li><a href="#operations-on-the-cache">Operations on the cache</a></li><li><a href="#events">Events</a></li></ul></nav><div class="content"><div><div class="spec type" id="type-t" class="anchored"><a href="#type-t" class="anchor"></a><code><span class="keyword">type</span> <span>'a t</span></code></div><div><p>The type of an ARP handler. It is polymorphic over the tasks waiting for an ARP reply.</p></div></div><h3 id="constructor"><a href="#constructor" class="anchor"></a>Constructor</h3><div><div class="spec value" id="val-create" class="anchored"><a href="#val-create" class="anchor"></a><code><span class="keyword">val</span> create : <span>?&#8288;timeout:int</span> <span>&#45;&gt;</span> <span>?&#8288;retries:int</span> <span>&#45;&gt;</span> <span>?&#8288;logsrc:<a href="../../logs/Logs/index.html#type-src">Logs.src</a></span> <span>&#45;&gt;</span> <span>?&#8288;ipaddr:<a href="../../ipaddr/Ipaddr/V4/index.html#type-t">Ipaddr.V4.t</a></span> <span>&#45;&gt;</span> <a href="../../macaddr/Macaddr/index.html#type-t">Macaddr.t</a> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> * <span><span>(<a href="../Arp_packet/index.html#type-t">Arp_packet.t</a> * <a href="../../macaddr/Macaddr/index.html#type-t">Macaddr.t</a>)</span> option</span></code></div><div><p><code>create ~timeout ~retries ~ipaddr mac)</code> is <code>t, garp</code>. The constructor of the ARP handler, specifying timeouts (defaults to 800) and amount of retries (defaults to 5). If <code>ipaddr</code> is provided, a gratuitous ARP request will be encoded in <code>garp</code>, otherwise <a href="../../ipaddr/Ipaddr/V4/index.html#val-any"><code>Ipaddr.V4.any</code></a> is temporarily used and <code>garp</code> is <code>None</code>. The value of <code>timeout</code> is the number of <code>Tick</code> events.</p><dl><dt>raises Invalid_argument</dt><dd><p>is <code>timeout</code> is 0 or negative or <code>retries</code> is negative.</p></dd></dl></div></div><div><div class="spec value" id="val-pp" class="anchored"><a href="#val-pp" class="anchor"></a><code><span class="keyword">val</span> pp : <a href="../../ocaml/Stdlib/Format/index.html#type-formatter">Stdlib.Format.formatter</a> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> unit</code></div><div><p><code>pp ppf t</code> prints the ARP handler <code>t</code> on <code>ppf</code> by iterating over all cache entries.</p></div></div><h3 id="predicates"><a href="#predicates" class="anchor"></a>Predicates</h3><div><div class="spec value" id="val-ips" class="anchored"><a href="#val-ips" class="anchor"></a><code><span class="keyword">val</span> ips : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span><a href="../../ipaddr/Ipaddr/V4/index.html#type-t">Ipaddr.V4.t</a> list</span></code></div><div><p><code>ips t</code> is <code>ips</code>, the advertised IPv4 addresses.</p></div></div><div><div class="spec value" id="val-mac" class="anchored"><a href="#val-mac" class="anchor"></a><code><span class="keyword">val</span> mac : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <a href="../../macaddr/Macaddr/index.html#type-t">Macaddr.t</a></code></div><div><p><code>mac t</code> is <code>mac</code>, the mac address used by the ARP handler.</p></div></div><div><div class="spec value" id="val-in_cache" class="anchored"><a href="#val-in_cache" class="anchor"></a><code><span class="keyword">val</span> in_cache : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <a href="../../ipaddr/Ipaddr/V4/index.html#type-t">Ipaddr.V4.t</a> <span>&#45;&gt;</span> <span><a href="../../macaddr/Macaddr/index.html#type-t">Macaddr.t</a> option</span></code></div><div><p><code>in_cache t ip</code> is <code>mac option</code>, a MAC address if the ARP cache contains an entry, <code>None</code> otherwise.</p></div></div><h3 id="operations-on-the-cache"><a href="#operations-on-the-cache" class="anchor"></a>Operations on the cache</h3><div><div class="spec value" id="val-static" class="anchored"><a href="#val-static" class="anchor"></a><code><span class="keyword">val</span> static : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <a href="../../ipaddr/Ipaddr/V4/index.html#type-t">Ipaddr.V4.t</a> <span>&#45;&gt;</span> <a href="../../macaddr/Macaddr/index.html#type-t">Macaddr.t</a> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> * <span><span class="type-var">'a</span> option</span></code></div><div><p><code>static t ip mac</code> is <code>t', as</code>, where <code>t'</code> is <code>t</code> extended with a static ARP entry using the given <code>ip</code> and <code>mac</code>. The tasks waiting for <code>ip</code> are <code>as</code>.</p></div></div><div><div class="spec value" id="val-alias" class="anchored"><a href="#val-alias" class="anchor"></a><code><span class="keyword">val</span> alias : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <a href="../../ipaddr/Ipaddr/V4/index.html#type-t">Ipaddr.V4.t</a> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> * <span>(<a href="../Arp_packet/index.html#type-t">Arp_packet.t</a> * <a href="../../macaddr/Macaddr/index.html#type-t">Macaddr.t</a>)</span> * <span><span class="type-var">'a</span> option</span></code></div><div><p><code>alias t ip</code> is <code>t', out, as</code>, where <code>t'</code> is <code>t</code> extended by a static ARP entry for <code>ip</code>. This entry will be used to answer further ARP requests. <code>out</code> is a gratuitous ARP frame. The tasks waiting for <code>ip</code> are <code>as</code>.</p></div></div><div><div class="spec value" id="val-remove" class="anchored"><a href="#val-remove" class="anchor"></a><code><span class="keyword">val</span> remove : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <a href="../../ipaddr/Ipaddr/V4/index.html#type-t">Ipaddr.V4.t</a> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span></code></div><div><p><code>remove t ip</code> is <code>t'</code>, where <code>ip</code> is no longer in the cache.</p></div></div><h3 id="events"><a href="#events" class="anchor"></a>Events</h3><div><div class="spec value" id="val-tick" class="anchored"><a href="#val-tick" class="anchor"></a><code><span class="keyword">val</span> tick : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> * <span><span>(<a href="../Arp_packet/index.html#type-t">Arp_packet.t</a> * <a href="../../macaddr/Macaddr/index.html#type-t">Macaddr.t</a>)</span> list</span> * <span><span class="type-var">'a</span> list</span></code></div><div><p><code>tick t</code> is <code>t', requests, timeouts</code>, which advances the state <code>t</code> into <code>t'</code>. Possibly retransmissions of ARP requests need to be done, provided in the <code>requests</code> list. Timed out queries are in the <code>timeouts</code> list.</p></div></div><div><div class="spec value" id="val-input" class="anchored"><a href="#val-input" class="anchor"></a><code><span class="keyword">val</span> input : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <a href="../../cstruct/Cstruct/index.html#type-t">Cstruct.t</a> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> * <span><span>(<a href="../Arp_packet/index.html#type-t">Arp_packet.t</a> * <a href="../../macaddr/Macaddr/index.html#type-t">Macaddr.t</a>)</span> option</span> * <span><span>(<a href="../../macaddr/Macaddr/index.html#type-t">Macaddr.t</a> * <span class="type-var">'a</span>)</span> option</span></code></div><div><p><code>input t buf</code> is <code>t', reply, w</code>, which handles the input buffer <code>buf</code> in the state <code>t</code>. The state is transformed into <code>t'</code>. If it was an ARP request for one of our IPv4 addresses, an ARP reply should be send out <code>reply</code>. If the input was an awaited ARP reply, some elements <code>w</code> can be informed.</p></div></div><div><div class="spec type" id="type-qres" class="anchored"><a href="#type-qres" class="anchor"></a><code><span class="keyword">type</span> <span>'a qres</span> = </code><table><tr id="type-qres.Mac" class="anchored"><td class="def variant constructor"><a href="#type-qres.Mac" class="anchor"></a><code>| <span class="constructor">Mac</span> <span class="keyword">of</span> <a href="../../macaddr/Macaddr/index.html#type-t">Macaddr.t</a></code></td></tr><tr id="type-qres.Wait" class="anchored"><td class="def variant constructor"><a href="#type-qres.Wait" class="anchor"></a><code>| <span class="constructor">Wait</span> <span class="keyword">of</span> <span class="type-var">'a</span></code></td></tr><tr id="type-qres.RequestWait" class="anchored"><td class="def variant constructor"><a href="#type-qres.RequestWait" class="anchor"></a><code>| <span class="constructor">RequestWait</span> <span class="keyword">of</span> <a href="../Arp_packet/index.html#type-t">Arp_packet.t</a> * <a href="../../macaddr/Macaddr/index.html#type-t">Macaddr.t</a> * <span class="type-var">'a</span></code></td></tr></table></div><div><p>The type returned by query, either a <code>Mac</code> and a mac address, or <code>Wait</code> for a reply, or <code>RequestWait</code>, consisting of an ARP request to be send on the wire, and await its answer.</p></div></div><div><div class="spec value" id="val-query" class="anchored"><a href="#val-query" class="anchor"></a><code><span class="keyword">val</span> query : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <a href="../../ipaddr/Ipaddr/V4/index.html#type-t">Ipaddr.V4.t</a> <span>&#45;&gt;</span> <span>(<span><span class="type-var">'a</span> option</span> <span>&#45;&gt;</span> <span class="type-var">'a</span>)</span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> * <span><span class="type-var">'a</span> <a href="index.html#type-qres">qres</a></span></code></div><div><p><code>query t ip merge</code> is <code>t', qres</code>, which looks for the <code>ip</code> in the cache. If it is found, its value is <code>Mac mac</code>. If the <code>ip</code> is not in the cache, either some <code>'a</code> is waiting for it already, then the value is <code>Wait a</code>, where <code>a</code> is produced by applying <code>merge (Some 'a)</code> to the waiting thing. Otherwise, both an ARP request needs to be send out, and the value of <code>merge None</code> is put into the cache, both as part of <code>RequestWait</code>.</p></div></div></div></body></html>